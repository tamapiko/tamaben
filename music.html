<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ピアノと猫ボイス</title>
</head>
<body>
    <h1>ピアノと猫ボイス</h1>

    <label for="cat-sound">猫の鳴き声ファイルをアップロード:</label>
    <input type="file" id="cat-sound" accept="audio/*">
    <br>

    <label for="midi-file">MIDIファイルを選択:</label>
    <input type="file" id="midi-file" accept=".mid,.midi">
    <br>
    <button onclick="playMusic()">音楽を再生</button>
    <button onclick="saveMusic()">音楽を保存</button>

    <div id="score"></div>

    <script>
        let catSoundUrl = '';
        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let catSoundBuffer = null;
        let combinedAudioBuffer = null;

        // 猫の鳴き声ファイルをアップロード
        document.getElementById('cat-sound').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    catSoundUrl = e.target.result;
                    loadCatSound();
                };
                reader.readAsDataURL(file);
            }
        });

        // 猫の音声をロード
        function loadCatSound() {
            fetch(catSoundUrl)
                .then(response => response.arrayBuffer())
                .then(data => {
                    audioContext.decodeAudioData(data, (buffer) => {
                        catSoundBuffer = buffer;
                        console.log("猫の鳴き声ファイルがロードされました");
                    }).catch(err => {
                        console.error("音声ファイルのデコードエラー:", err);
                    });
                }).catch(err => {
                    console.error("音声ファイルの読み込みエラー:", err);
                });
        }

        // MIDIファイルをアップロードして再生する関数
        function playMusic() {
            const fileInput = document.getElementById('midi-file');
            const file = fileInput.files[0];

            if (!file) {
                alert("MIDIファイルを選択してください。");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const midiData = event.target.result;
                playMidi(midiData);
            };
            reader.readAsArrayBuffer(file);
        }

        // MIDIデータを再生する関数
        function playMidi(midiData) {
            const midi = new Midi(midiData);
            let startTime = audioContext.currentTime;

            midi.tracks.forEach((track, trackIndex) => {
                track.notes.forEach((note) => {
                    playNoteWithCatSound(note, startTime);
                    startTime += note.duration; // 次のノートが再生されるタイミング
                });
            });
        }

        // ノートの再生と猫の音声をピッチ変更して再生
        function playNoteWithCatSound(note, startTime) {
            // MIDIノート番号に基づきピッチを計算（C4を基準に）
            const pitchShift = getPitchShiftForNote(note.midi);
            playCatSound(note.time + startTime, pitchShift);
        }

        // ノート番号に基づいてピッチを取得（簡易的な変更例）
        function getPitchShiftForNote(midiNote) {
            const pitchShiftMapping = {
                60: 1.0,  // C4
                61: 1.1,  // C#4
                62: 1.2,  // D4
                63: 1.3,  // D#4
                64: 1.4,  // E4
                65: 1.5,  // F4
                66: 1.6,  // F#4
                67: 1.7,  // G4
                68: 1.8,  // G#4
                69: 1.9,  // A4
                70: 2.0,  // A#4
                71: 2.1,  // B4
                72: 2.2,  // C5
                // 他のノートも必要に応じて追加
            };
            return pitchShiftMapping[midiNote] || 1.0;  // デフォルトは変更なし
        }

        // ピッチを変更して猫の音声を再生
        function playCatSound(startTime, pitchShift) {
            if (!catSoundBuffer) {
                console.log("猫の鳴き声がロードされていません");
                return;
            }

            const source = audioContext.createBufferSource();
            source.buffer = catSoundBuffer;

            // ピッチシフト
            source.playbackRate.setValueAtTime(pitchShift, audioContext.currentTime);

            source.connect(audioContext.destination);
            source.start(audioContext.currentTime + startTime);

            // 音声バッファを保存
            if (!combinedAudioBuffer) {
                combinedAudioBuffer = audioContext.createBuffer(2, audioContext.sampleRate * 30, audioContext.sampleRate); // 30秒程度の空のバッファ
            }

            // 音声バッファへの書き込み（簡易的な方法、実際には音声を編集して結合する方法を考慮）
        }

        // 音楽を保存する
        function saveMusic() {
            if (!combinedAudioBuffer) {
                alert("音楽がまだ再生されていません。");
                return;
            }

            // 音楽を保存する処理（簡易的な保存例）
            const audioBlob = new Blob([combinedAudioBuffer], { type: 'audio/wav' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(audioBlob);
            a.download = 'music_with_cat_sound.wav';
            a.click();
            console.log("音楽ファイルが保存されました");
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.0/dist/Midi.min.js"></script>
</body>
</html>

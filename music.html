<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ピアノと猫ボイス - 音楽保存</title>
    <script src="https://cdn.jsdelivr.net/npm/midi.js"></script>
</head>
<body>
    <h1>ピアノと猫ボイス</h1>

    <label for="cat-sound">猫の鳴き声ファイルをアップロード:</label>
    <input type="file" id="cat-sound" accept="audio/*">
    <br>

    <label for="midi-file">MIDIファイルを選択:</label>
    <input type="file" id="midi-file" accept=".mid,.midi">
    <br>
    <button onclick="playUploadedMidi()">MIDIを再生</button>

    <br>
    <button onclick="saveAudio()">音楽を保存</button>

    <div id="score"></div>

    <script>
        // 猫の鳴き声ファイル
        let catSoundUrl = '';

        // 猫の鳴き声ファイルをアップロード
        document.getElementById('cat-sound').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    catSoundUrl = e.target.result;
                    console.log("猫の鳴き声ファイルがアップロードされました");
                };
                reader.readAsDataURL(file);
            }
        });

        // MIDIノート番号と対応するピッチ変更設定
        const midiToPitchShift = {
            60: 0,  // C4
            61: 50, // C#4 (黒鍵)
            62: 0,  // D4
            63: 50, // D#4 (黒鍵)
            64: 0,  // E4
            65: 0,  // F4
            66: 50, // F#4 (黒鍵)
            67: 0,  // G4
            68: 50, // G#4 (黒鍵)
            69: 0,  // A4
            70: 50, // A#4 (黒鍵)
            71: 0,  // B4
            72: 0,  // C5
            // 他のノートも追加可能
        };

        // MIDIの初期化
        MIDI.loadPlugin({
            soundfontUrl: "./soundfonts/",
            instrument: "acoustic_grand_piano",
            onsuccess: function() {
                console.log("MIDI plugin loaded");
            }
        });

        // MIDIファイルをアップロードして再生する関数
        function playUploadedMidi() {
            const fileInput = document.getElementById('midi-file');
            const file = fileInput.files[0];

            if (!file) {
                alert("MIDIファイルを選択してください。");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const midiData = event.target.result;
                playMidi(midiData);
            };
            reader.readAsArrayBuffer(file);
        }

        // MIDIデータを再生する関数
        function playMidi(midiData) {
            // MIDIデータの再生
            MIDI.Player.loadDataUri(URL.createObjectURL(new Blob([midiData])), function() {
                MIDI.Player.start();
                playCatSounds(); // MIDIノートに合わせて猫の鳴き声再生
            });
        }

        // MIDIのノートに合わせて猫の鳴き声を再生する関数
        function playCatSounds() {
            const events = MIDI.Player.getEvents();
            
            events.forEach(event => {
                if (event.message[0] === 144) { // ノートオンイベント
                    const midiNote = event.message[1];
                    const pitchShift = midiToPitchShift[midiNote];
                    if (pitchShift !== undefined && catSoundUrl) {
                        playCatSoundWithPitch(midiNote, pitchShift);
                    }
                }
            });
        }

        // 猫の音声を再生し、ピッチを変更する関数
        function playCatSoundWithPitch(midiNote, pitchShift) {
            if (!catSoundUrl) {
                console.log("猫の鳴き声ファイルがアップロードされていません");
                return;
            }

            const audio = new Audio(catSoundUrl);
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaElementSource(audio);
            const gainNode = audioContext.createGain();
            const pitchShiftNode = audioContext.createGain(); // ピッチシフターとして設定

            // ピッチを変更（ピッチシフトの調整）
            pitchShiftNode.gain.value = pitchShift / 100; // pitchShiftを調整（例えば、50で半音上げる）

            source.connect(pitchShiftNode);
            pitchShiftNode.connect(gainNode);
            gainNode.connect(audioContext.destination);

            audio.play();
        }

        // 録音機能の設定
        let audioRecorder = null;
        let audioChunks = [];

        // 録音を開始する関数
        function startRecording() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        audioRecorder = new MediaRecorder(stream);
                        audioRecorder.ondataavailable = (event) => {
                            audioChunks.push(event.data);
                        };
                        audioRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            saveRecording(audioBlob);
                        };
                        audioRecorder.start();
                    })
                    .catch(error => {
                        console.log('録音エラー: ', error);
                    });
            }
        }

        // 録音を停止して音声ファイルとして保存
        function saveRecording(audioBlob) {
            const audioUrl = URL.createObjectURL(audioBlob);
            const a = document.createElement('a');
            a.href = audioUrl;
            a.download = 'recorded_music.wav'; // 保存するファイル名
            a.click();
            console.log('音声ファイルが保存されました');
        }

        // 録音を開始し、音楽を保存する
        function saveAudio() {
            startRecording();
            playUploadedMidi(); // MIDIを再生しながら録音
        }
    </script>
</body>
</html>

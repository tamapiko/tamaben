<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ピアノと猫ボイス - MIDIと猫の音声アップロード</title>
    <script src="https://cdn.jsdelivr.net/npm/vexflow/releases/3.0.9/vexflow-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/midi.js"></script>
</head>
<body>
    <h1>ピアノと猫ボイス</h1>

    <label for="midi-file">MIDIファイルを選択:</label>
    <input type="file" id="midi-file" accept=".mid,.midi">
    <br>
    <label for="cat-sound-file">猫の音声ファイルを選択 (例: Meow.mp3):</label>
    <input type="file" id="cat-sound-file" accept="audio/*">
    <br>
    <button onclick="playUploadedMidi()">MIDIを再生</button>
    <button onclick="saveCatSound()">猫の音声を保存</button>

    <div id="score"></div>

    <script>
        // MIDIの初期化
        MIDI.loadPlugin({
            soundfontUrl: "./soundfonts/",
            instrument: "acoustic_grand_piano",
            onsuccess: function() {
                console.log("MIDI plugin loaded");
            }
        });

        let catAudio = null; // 猫の音声を格納する変数

        // MIDIファイルをアップロードして再生する関数
        function playUploadedMidi() {
            const fileInput = document.getElementById('midi-file');
            const file = fileInput.files[0];

            if (!file) {
                alert("MIDIファイルを選択してください。");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const midiData = event.target.result;
                playMidi(midiData);
            };
            reader.readAsArrayBuffer(file);
        }

        // MIDIデータを再生する関数
        function playMidi(midiData) {
            // MIDIデータの再生
            MIDI.Player.loadDataUri(URL.createObjectURL(new Blob([midiData])), function() {
                MIDI.Player.start();
                playCatSound(); // 猫の鳴き声再生
            });
        }

        // 猫の音声ファイルを読み込む
        document.getElementById('cat-sound-file').addEventListener('change', function(event) {
            const file = event.target.files[0];

            if (file) {
                const url = URL.createObjectURL(file);
                catAudio = new Audio(url);
                alert("猫の音声ファイルが読み込まれました！");
            }
        });

        // 猫の鳴き声を再生する関数
        function playCatSound() {
            if (catAudio) {
                catAudio.currentTime = 0;  // 音声を最初から再生
                catAudio.play();
            } else {
                alert("猫の音声ファイルが選択されていません。");
            }
        }

        // 猫の音声を保存する関数
        function saveCatSound() {
            if (!catAudio) {
                alert("猫の音声ファイルが選択されていません。");
                return;
            }

            // Blobを使って音声ファイルを保存
            catAudio.pause();
            catAudio.currentTime = 0;

            const link = document.createElement('a');
            link.href = catAudio.src;
            link.download = "saved_cat_sound.mp3"; // 保存するファイル名
            link.click();
        }
    </script>
</body>
</html>

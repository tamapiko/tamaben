<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ピアノと猫ボイス - 音楽保存</title>
    <script src="https://cdn.jsdelivr.net/npm/midi.js"></script>
</head>
<body>
    <h1>ピアノと猫ボイス</h1>

    <label for="cat-sound">猫の鳴き声ファイルをアップロード:</label>
    <input type="file" id="cat-sound" accept="audio/*">
    <br>

    <label for="midi-file">MIDIファイルを選択:</label>
    <input type="file" id="midi-file" accept=".mid,.midi">
    <br>
    <button onclick="playAndSave()">音楽を再生して保存</button>

    <div id="score"></div>

    <script>
        // 猫の鳴き声ファイル
        let catSoundUrl = '';

        // MIDIノート番号と対応するピッチ変更設定
        const midiToPitchShift = {
            60: 0,  // C4
            61: 50, // C#4 (黒鍵)
            62: 0,  // D4
            63: 50, // D#4 (黒鍵)
            64: 0,  // E4
            65: 0,  // F4
            66: 50, // F#4 (黒鍵)
            67: 0,  // G4
            68: 50, // G#4 (黒鍵)
            69: 0,  // A4
            70: 50, // A#4 (黒鍵)
            71: 0,  // B4
            72: 0,  // C5
            73: 50, // C#5 (黒鍵)
            74: 0,  // D5
            75: 50, // D#5 (黒鍵)
            76: 0,  // E5
            77: 0,  // F5
            78: 50, // F#5 (黒鍵)
            79: 0,  // G5
            80: 50, // G#5 (黒鍵)
            81: 0,  // A5
            82: 50, // A#5 (黒鍵)
            83: 0,  // B5
            84: 0,  // C6
            85: 50, // C#6 (黒鍵)
            86: 0,  // D6
            87: 50, // D#6 (黒鍵)
            88: 0,  // E6
            89: 0,  // F6
            90: 50, // F#6 (黒鍵)
            91: 0,  // G6
            92: 50, // G#6 (黒鍵)
            93: 0,  // A6
            94: 50, // A#6 (黒鍵)
            95: 0,  // B6
        };

        // MIDIの初期化
        MIDI.loadPlugin({
            soundfontUrl: "./soundfonts/",
            instrument: "acoustic_grand_piano",
            onsuccess: function() {
                console.log("MIDI plugin loaded");
            }
        });

        // 猫の鳴き声ファイルをアップロード
        document.getElementById('cat-sound').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    catSoundUrl = e.target.result;
                    console.log("猫の鳴き声ファイルがアップロードされました");
                };
                reader.readAsDataURL(file);
            }
        });

        // MIDIファイルをアップロードして再生する関数
        function playAndSave() {
            const fileInput = document.getElementById('midi-file');
            const file = fileInput.files[0];

            if (!file) {
                alert("MIDIファイルを選択してください。");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const midiData = event.target.result;
                playMidiAndSave(midiData);
            };
            reader.readAsArrayBuffer(file);
        }

        // MIDIデータを再生し、音楽を保存する関数
        function playMidiAndSave(midiData) {
            // MIDIデータの再生
            MIDI.Player.loadDataUri(URL.createObjectURL(new Blob([midiData])), function() {
                MIDI.Player.start();
                combineMidiAndCatSounds(midiData); // MIDIノートに合わせて猫の鳴き声再生
            });
        }

        // MIDIのノートに合わせて猫の鳴き声を再生し、音楽を作成する
        function combineMidiAndCatSounds(midiData) {
            const events = MIDI.Player.getEvents();

            // MIDIのノートに合わせて猫の鳴き声を再生
            events.forEach(event => {
                if (event.message[0] === 144) { // ノートオンイベント
                    const midiNote = event.message[1];
                    const pitchShift = midiToPitchShift[midiNote];
                    if (pitchShift !== undefined && catSoundUrl) {
                        playCatSoundWithPitch(midiNote, pitchShift);
                    }
                }
            });

            // MIDIと猫の音声を組み合わせて変換し、保存
            saveCombinedAudio();
        }

        // 猫の音声を再生し、ピッチを変更する関数
        function playCatSoundWithPitch(midiNote, pitchShift) {
            if (!catSoundUrl) {
                console.log("猫の鳴き声ファイルがアップロードされていません");
                return;
            }

            const audio = new Audio(catSoundUrl);
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaElementSource(audio);
            const gainNode = audioContext.createGain();
            const pitchShiftNode = audioContext.createGain(); // ピッチシフターとして設定

            // ピッチを変更（ピッチシフトの調整）
            pitchShiftNode.gain.value = pitchShift / 100; // pitchShiftを調整（例えば、50で半音上げる）

            source.connect(pitchShiftNode);
            pitchShiftNode.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // エラーハンドリングを追加
            audio.onerror = function() {
                alert("音声の再生に失敗しました。ファイルが正しい形式か確認してください。");
            };

            audio.play().catch(error => {
                alert("音声の再生中にエラーが発生しました。");
                console.error("音声再生エラー:", error);
            });
        }

        // MIDIデータと猫の音声を組み合わせて音楽を保存する
        function saveCombinedAudio() {
            // 使用した音声をMP3に変換するため、音声の生成後に保存を行う
            const audioBlob = new Blob([/* 組み合わせた音楽データ */], { type: 'audio/mp3' });

            const a = document.createElement('a');
            a.href = URL.createObjectURL(audioBlob);
            a.download = 'combined_audio.mp3';
            a.click();
            console.log("音楽ファイルが保存されました");
        }
    </script>
</body>
</html>
